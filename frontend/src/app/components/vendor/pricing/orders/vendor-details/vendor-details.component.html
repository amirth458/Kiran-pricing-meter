<div class="wrapper container-fluid">
  <div class="d-flex justify-content-between mt-4 align-items-center mb-2">
    <p class="part-header font-weight-bold mr-auto">Accepted Order Details</p>
    <p *ngIf="bidOrderStatus?.name === 'COMPLETED_WITH_NO_RESPONSE'">
      <button class="btn btn-declined d-none" (click)="onDeleteBidding()">
        Delete Bidding
      </button>
      <button class="btn btn-approved ml-3" (click)="onRestartBidding()">
        Restart Bidding
      </button>
    </p>
    <ng-container [ngSwitch]="type">
      <ng-container *ngSwitchCase="'release'">
        <button
          class="btn green-btn release-btn"
          [disabled]="(priorityRows | supplier: (suppliers$ | async):false).length == 0"
          (click)="showModal(content)"
        >
          Release Sub Orders for Bidding
        </button>
      </ng-container>
      <ng-container *ngSwitchCase="'released'">
        <span class="text-green">Bidding Complete & Released</span>
      </ng-container>
      <ng-container *ngSwitchCase="'confirmation'">
        <p class="text-orange">
          <ng-container
            *ngIf="
              timeLeft &&
              bidOrderStatus &&
              bidOrderStatus.name === biddingOrderStatus.CONFIRMATION_RECEIVED &&
              bidOrderStatus.name === biddingOrderStatus.IN_PROGRESS
            "
          >
            Unresponsive time left before releasing to next supplier:
            {{ timeLeft }}
          </ng-container>

          <ng-container
            *ngIf="!timeLeft && bidOrderStatus && bidOrderStatus.name === biddingOrderStatus.WAITING_FOR_RELEASE"
          >
            Time Expired
          </ng-container>
        </p>
        <p class="text-blue">Bidding In Progress</p>
      </ng-container>
      <ng-container *ngSwitchDefault>Oops! Something went wrong!</ng-container>
    </ng-container>
  </div>

  <div class="row">
    <div class="col-12 theme-table">
      <ag-grid-angular
        class="ag-theme-balham w-100 h-100"
        [class.grid-empty]="(orderDetails || []).length === 0"
        [rowData]="orderDetails"
        [gridOptions]="gridOptions[0]"
        (gridReady)="onGridReady(0, $event)"
        domLayout="autoHeight"
      ></ag-grid-angular>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-4 align-items-center" *ngIf="!bidOrderId">
    <p class="part-header font-weight-bold">Matching Suppliers Profiles</p>
    <ng-container [ngSwitch]="type">
      <ng-container *ngSwitchCase="'release'">
        <a class="priority-btn" (click)="toggleChangePriority()">{{
          changePriority ? 'Confirm Priority' : 'Change Priority'
        }}</a>
      </ng-container>
      <ng-container *ngSwitchCase="'released'"> </ng-container>
      <ng-container *ngSwitchDefault>Ooops! Something went wrong!</ng-container>
    </ng-container>
  </div>

  <div class="row" *ngIf="!bidOrderId">
    <ng-container *ngIf="changePriority; else plainMode">
      <div
        class="col-12 theme-table"
        *ngIf="priorityRows | supplier: (suppliers$ | async):false as allowedSupplierList"
      >
        <ag-grid-angular
          class="ag-theme-balham w-100 h-100 supplier-table selected-suppliers"
          [rowData]="allowedSupplierList"
          [class.grid-empty]="(allowedSupplierList || []).length === 0"
          [gridOptions]="gridOptions[1]"
          (gridReady)="onGridReady(1, $event)"
          [rowDragManaged]="true"
          [animateRows]="true"
          (rowDragEnd)="onRowDragEnd($event)"
          domLayout="autoHeight"
        >
        </ag-grid-angular>
      </div>
      <div class=" mt-4 w-100">
        <p class="part-header font-weight-bold pl-3">Removed Suppliers Profiles</p>
        <div
          class="col-12 theme-table"
          *ngIf="priorityRows | supplier: (suppliers$ | async):true as blockedSupplierList"
        >
          <ag-grid-angular
            class="ag-theme-balham w-100 h-100 supplier-table removed-suppliers"
            [rowData]="blockedSupplierList"
            [class.grid-empty]="(blockedSupplierList || []).length === 0"
            [gridOptions]="gridOptions[1]"
            (gridReady)="onGridReady(1, $event)"
            [rowDragManaged]="true"
            [animateRows]="true"
            (rowDragEnd)="onRowDragEnd($event)"
            domLayout="autoHeight"
          >
          </ag-grid-angular>
        </div>
      </div>
    </ng-container>
    <ng-template #plainMode>
      <div
        class="position-relative w-100 h-100"
        *ngIf="matchedProfiles | supplier: (suppliers$ | async):false as profiles"
      >
        <ng-container *ngIf="!loadingProfiles; else loading">
          <div class="col-12 theme-table">
            <ag-grid-angular
              class="ag-theme-balham w-100 h-100 suppliers-profiles"
              [rowData]="profiles"
              [class.grid-empty]="(profiles || []).length === 0"
              [gridOptions]="gridOptions[2]"
              (gridReady)="onGridReady(2, $event)"
              domLayout="autoHeight"
            >
            </ag-grid-angular>
          </div>
        </ng-container>
      </div>
    </ng-template>
  </div>
  <div class="d-flex justify-content-between mt-4 mb-2 align-items-center" *ngIf="bidOrderId">
    <span class="part-header font-weight-bold">Bidding Status</span>
    <div class="d-flex align-items-center">
      <button
        class="btn theme btn-primary px-4 py-2 mr-4"
        *ngIf="type === 'confirmation'"
        [disabled]="(bidding || []).length === 0 || gridOptions[4]?.api?.getSelectedRows()?.length === 0"
        (click)="sendMail()"
      >
        <small><i class="far fa-envelope"></i> &nbsp;Send Mail</small>
      </button>
      <a class="priority-btn text-nowrap" (click)="toggleVendorList = !toggleVendorList">{{
        toggleVendorList ? 'View Vendor List' : 'View Matching Profile'
      }}</a>
    </div>
  </div>
  <div class="row" *ngIf="bidOrderId">
    <div class="col-12 theme-table bidding-orders position-relative">
      <ag-grid-angular
        *ngIf="!toggleVendorList"
        class="ag-theme-balham w-100 h-100 pop-over-grid"
        [class.grid-empty]="(bidding || []).length === 0"
        [rowData]="bidding"
        [gridOptions]="gridOptions[4]"
        rowSelection="multiple"
        [rowMultiSelectWithClick]="true"
        (gridReady)="onGridReady(4, $event)"
        domLayout="autoHeight"
      ></ag-grid-angular>
      <ng-container *ngIf="toggleVendorList">
        <ng-container *ngIf="matches$ | async as matchedData; else loading">
          <ag-grid-angular
            class="ag-theme-balham w-100 h-100 matched-profiles"
            [class.grid-empty]="matchedData.length === 0"
            [rowData]="matchedData.items || []"
            [gridOptions]="gridOptions[5]"
            (gridReady)="onGridReady(5, $event)"
            domLayout="autoHeight"
          ></ag-grid-angular>
        </ng-container>
      </ng-container>
    </div>
  </div>
</div>

<ng-template #content let-modal>
  <div class="modal-container">
    <div class="modal-header">
      <h5 class="modal-title">
        Confirm Sub-Order Release
      </h5>
    </div>
    <div class="modal-container px-5 py-2">
      <div class="table">
        <div class="row header p-3">
          <div class="col-6">Pricing Information</div>
          <div class="col-6">Value</div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            Starting Release Price as % of Sale
          </div>
          <div class="setting-value p-3 col-6">% {{ subOrderRelease.initialBidSoldPricePercent }}</div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            Initial Release Price
          </div>
          <div class="setting-value p-3 col-6">
            $
            {{ (initialPrice * (subOrderRelease.initialBidSoldPricePercent / 100)).toFixed(2) }}
          </div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            Release to How Many Suppliers at a Time
          </div>
          <div class="setting-value p-3 col-6">
            {{ subOrderRelease.maxSupplierViewOpportunity }}
          </div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            Time Increment for Bid Increase if No vender accepts
          </div>
          <div class="setting-value p-3 col-6">{{ subOrderRelease.minBidIncreaseTimeMinutes }} min</div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            Increase amount by
          </div>
          <div class="setting-value p-3 col-6">{{ subOrderRelease.incrementBidAmountPercent }} %</div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            % of sale price without fullfillment to revert to customers
          </div>
          <div class="setting-value p-3 col-6">{{ subOrderRelease.maxPercentWithoutFulfillment }}%</div>
        </div>
        <div class="row mb-1">
          <div class="setting-name p-3 col-6">
            Unresponsive time before releasing to next supplier
          </div>
          <div class="setting-value p-3 col-6">{{ subOrderRelease.maxBidUnresponsiveTimeMinutes }} min</div>
        </div>
      </div>
    </div>
    <div class="modal-footer d-flex p-3 align-items-center justify-content-around">
      <button class="btn orange-btn" (click)="modal.dismiss()">Cancel</button>
      <button class="btn green-btn" (click)="confirmSubOrderRelease()">
        Confirm
      </button>
    </div>
    <ngx-spinner
      [name]="'spinner1'"
      bdColor="rgba(255,255,255,0.5)"
      size="small"
      color="#74bf09"
      type="ball-clip-rotate"
      [fullScreen]="false"
    >
    </ngx-spinner>
  </div>
</ng-template>

<ng-template #pricingProfileModal let-modal>
  <div class="modal-container text-theme">
    <div class="modal-header">
      <h5 class="modal-title">{{ processProfile?.vendorName }} Profile</h5>
      <a (click)="modal.dismiss()">
        <i class="fa fa-times"></i>
      </a>
    </div>
    <div class="modal-container px-5 py-3">
      <p class="text-center text-theme">
        {{ processProfile?.name }}
      </p>
      <div class="col-12 theme-table">
        <ag-grid-angular
          class="ag-theme-balham w-100 h-100"
          [class.grid-empty]="(processProfile?.processPricingList || []).length === 0"
          [rowData]="processProfile?.processPricingList || []"
          [gridOptions]="gridOptions[3]"
          (gridReady)="onGridReady(3, $event)"
          domLayout="autoHeight"
        ></ag-grid-angular>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #statusCell let-row let-column="params">
  <ng-container *ngIf="row.bidProcessStatus">
    <ng-container [ngSwitch]="row.bidProcessStatus.name">
      <ng-container *ngSwitchCase="biddingStatus.ACCEPTED">
        <div class="d-flex flex-row pt-1 pb-1 align-items-center">
          <strong class="text-theme">
            {{ row.bidProcessStatus.description | titlecase }}
            <ng-container *ngIf="row?.counterOfferPrice"> ({{ row?.counterOfferPrice | currency: '$' }}) </ng-container>
            <ng-container *ngIf="!row?.counterOfferPrice"> ({{ row?.bidOfferPrice | currency: '$' }}) </ng-container>
          </strong>
          <button
            *ngIf="type !== 'confirmation'"
            class="pl-5 bg-transparent text-theme-green border-0 font-weight-bold"
            (click)="viewOrderInfo(row?.bidProcessId)"
          >
            See Order Status
          </button>
          <button
            class="btn btn-primary confirm-btn ml-4 btn-sm"
            *ngIf="type === 'confirmation' && !toggleVendorList"
            (click)="openConfirmBidding(row)"
          >
            Confirm
          </button>
        </div>
      </ng-container>
      <ng-container *ngSwitchCase="biddingStatus.COUNTER_OFFER">
        <div class="d-flex flex-row pt-1 pb-1">
          <strong class="text-coutered">
            {{ row.bidProcessStatus.description | titlecase }}
            <ng-container *ngIf="row?.counterOfferPrice"> ({{ row?.counterOfferPrice | currency: '$' }}) </ng-container>
            <ng-container *ngIf="!row?.counterOfferPrice"> ({{ row?.bidOfferPrice | currency: '$' }}) </ng-container>
          </strong>
          <button
            class="btn btn-primary confirm-btn ml-4 btn-sm"
            *ngIf="type === 'confirmation' && !toggleVendorList"
            (click)="openConfirmBidding(row)"
          >
            Confirm
          </button>
        </div>
      </ng-container>
      <ng-container *ngSwitchCase="biddingStatus.NO_RESPONSE">
        <strong class="text-blue">{{ row.bidProcessStatus.description | titlecase }}</strong>
      </ng-container>
      <ng-container *ngSwitchCase="biddingStatus.REJECTED">
        <strong class="text-orange">{{ row.bidProcessStatus.description | titlecase }}</strong>
      </ng-container>
      <ng-container *ngSwitchCase="biddingStatus.QUEUED_FOR_LATER">
        <strong class="text-blue">{{ row.bidProcessStatus.description | titlecase }}</strong>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<ng-template #confirmBidding let-modal>
  <div class="modal-container">
    <div class="modal-header">
      <h5 class="modal-title text-theme-green pt-2">
        Confirm Bidding
      </h5>
      <button type="button" class="close" aria-label="Close" (click)="selectedBidding = null; modal.dismiss()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-container p-4">
      Do you want to confirm this sub order to
      {{ selectedBidding.vendorName }} for ${{
        biddingStatus.ACCEPTED === selectedBidding?.bidProcessStatus?.name
          ? selectedBidding?.bidOfferPrice || 0
          : selectedBidding?.counterOfferPrice || 0
      }}?
    </div>
    <div class="modal-footer d-flex px-4 py-4 align-items-center justify-content-center">
      <button class="btn orange-btn m-0" (click)="modal.dismiss()">
        Cancel
      </button>
      <button class="btn green-btn m-0 ml-5" (click)="onConfirmBidding()">
        Confirm
      </button>
    </div>
  </div>
</ng-template>

<ng-template #loading>
  <div class="d-flex justify-content-center align-items-center loading-panel">
    <ngx-spinner
      [name]="'spooler'"
      bdOpacity="0.7"
      bdColor="#fff"
      size="small"
      color="#74bf09"
      type="ball-clip-rotate"
      [fullScreen]="false"
    >
      <p class="m-0">Loading...</p>
    </ngx-spinner>
  </div>
</ng-template>

<ng-template #supplierStatusCell let-row let-column="params">
  <div class="d-flex flex-row justify-content-center align-items-center w-100 h-100">
    <a class="text-danger" *ngIf="row[column?.colDef?.field]" (click)="valueChange(row)">Remove from list</a>
    <a class="text-green" *ngIf="!row[column?.colDef?.field]" (click)="valueChange(row)">Move to the list</a>
  </div>
</ng-template>

<ng-template #sendEmailCell let-row let-column="params">
  <div class="d-flex flex-row justify-content-around align-items-center h-100 w-100">
    <!-- Email Communication -->
    <span class="text-green text-btn p-2" title="Send mail" (click)="sendMail(row)">
      <i class="far fa-envelope"></i>
    </span>
    <!-- End of Email Communication -->

    <!-- Note Communication -->
    <ng-container [ngSwitch]="type">
      <ng-container *ngSwitchCase="'confirmation'">
        <ng-container *ngIf="row?.bidProcessStatus?.name !== biddingStatus.REJECTED">
          <app-chat
            [participants]="row.userId ? [row.userId] : []"
            [id]="bidOrderId"
            [type]="chatTypeEnum.BID_OFFER"
            [value]="chat"
            (valueChange)="chat = $event"
          >
          </app-chat>
        </ng-container>
      </ng-container>
      <ng-container *ngSwitchCase="'released'">
        <app-chat
          *ngIf="row?.vendorOrderId"
          [participants]="row.userId ? [row.userId] : []"
          [id]="row?.vendorOrderId"
          [vendorId]="row?.vendorId"
          [type]="chatTypeEnum.VENDOR_ORDER"
          [value]="chat"
          (valueChange)="chat = $event"
        >
        </app-chat>
      </ng-container>
    </ng-container>
    <!--End of Note Communication -->

    <!-- Zoom Communication -->
    <ng-container *ngIf="(type == 'released' && row?.vendorOrderId) || type == 'confirmation'">
      <label class="text-green text-btn p-2 picker-icon" (click)="openDateTimeSelector(row)">
        <i class="far fa-calendar-alt"></i>
        <input
          *ngIf="meetingInfo[row.userId]"
          class="dt-control m-0 p-0"
          readonly
          #dateTimeSelector2
          [owlDateTime]="dt2"
          [owlDateTimeTrigger]="dt2"
          [(ngModel)]="meetingInfo[row.userId].startTime"
          [ngModelOptions]="{ standalone: true }"
          (ngModelChange)="onTimeChanged($event)"
        />
        <owl-date-time #dt2></owl-date-time>
      </label>
      <div class="d-flex h-100 meeting-time position-relative text-center d-flex align-items-center">
        <label
          class="d-flex flex-column justify-content-center align-items-center m-0 h-100"
          (click)="openDateTimeSelector(row)"
        >
          <span class="m-0 text-center ">
            Meeting Time
          </span>
          <span
            class="font-weight-bold time text-center"
            [ngClass]="{ 'theme-grey': meetingInfo[row.userId]?.isExpired || !meetingInfo[row.userId]?.startTime }"
          >
            <a
              *ngIf="meetingInfo[row.userId]?.startTime"
              [href]="
                user?.id == meetingInfo[row.userId].hostUserId
                  ? meetingInfo[row.userId]?.videoConferenceLinkForHost
                  : meetingInfo[row.userId]?.videoConferenceLinkForParticipant
              "
              target="_blank"
              class="underline"
            >
              {{ meetingInfo[row.userId]?.startTime | date: 'short' }}
            </a>
            <ng-container *ngIf="!meetingInfo[row.userId]?.startTime">
              -
            </ng-container>
          </span>
          <input
            *ngIf="meetingInfo[row.userId]"
            class="dt-control m-0 p-0 min-height"
            readonly
            #dateTimeSelector
            [owlDateTime]="dt1"
            [owlDateTimeTrigger]="dt1"
            [(ngModel)]="meetingInfo[row.userId].startTime"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onTimeChanged($event)"
          />
        </label>
      </div>
      <owl-date-time #dt1></owl-date-time>
    </ng-container>

    <!-- End of Zoom Communication -->

    <!--
    <p class="m-0 text-center">Meeting Time:</p>
    <label>
      <p *ngIf="!meetingInfo[row.userId].startTime" class="m-0 text-center font-weight-bold underline timer"
        (click)="openDateTimeSelector()">Schedule
        Meeting
      </p>

    </label> -->
  </div>
</ng-template>

<ng-template #sendMailModal let-modal>
  <app-send-mail-modal [from]="from" [to]="to" [cc]="cc" [bcc]="bcc" (close)="modal.dismiss()"></app-send-mail-modal>
</ng-template>

<ng-template #orderStatusTemplate let-modal>
  <div class="modal-container">
    <div class="modal-header">
      <h5 class="modal-title text-left pt-2 pl-2">Order Status No {{ vendorOrderId }}</h5>
      <button type="button" class="close" aria-label="Close" (click)="modal.dismiss()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-container p-4">
      <app-vendor-order-status
        [(order)]="vendorOrderId"
        [bidProcessId]="selectedBidProcessId"
        *ngIf="selectedBidProcessId"
      >
      </app-vendor-order-status>
    </div>
  </div>
</ng-template>

<ng-template #viewPricingProfile let-row>
  <span class="w-100 h-100 text-theme-green font-weight-bold view-pricing" (click)="openPricingView(row)">View</span>
</ng-template>
