<div class="col-12 d-flex flex-row p-0">
  <div class="col-9 p-0">
    <!-- TABLE -->
    <div class="col-12 theme-table p-0">
      <ag-grid-angular
        class="ag-theme-balham price-grid w-100 h-100"
        [class.empty-grid]="rowData?.length === 0"
        [rowData]="rowData"
        [gridOptions]="gridOptions"
        [domLayout]="'autoHeight'"
        (gridReady)="onGridReady($event)"
      >
      </ag-grid-angular>
    </div>
    <!-- /TABLE -->
    <!-- TAB -->
    <ngb-tabset class="col-12  d-block mt-4 p-0 border" [destroyOnHide]="false">
      <ngb-tab title="Price Detail">
        <ng-template ngbTabContent>
          <div class="table p-4">
            <ng-container
              *ngIf="!part?.manualPricingAllowed || part?.partStatusType.id === 3 || partQuote; else pricingSetting"
            >
              <ng-container [ngSwitch]="stage">
                <ng-container *ngSwitchCase="'unset'">
                  <table class="table table-borderless unset pricing-table w-75 m-0">
                    <thead>
                      <tr>
                        <th class="">Line Item</th>
                        <th class="text-center">Unit Count</th>
                        <th class="text-center">Unit Price</th>
                        <th class="text-center">Line Item Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let partQuoteDetail of partQuote?.partQuoteInvoiceItemDetails">
                        <td class="font-weight-bold text-theme">
                          {{ getInvoiceItem(partQuoteDetail.invoiceItemId) }}
                        </td>
                        <td class="text-center text-theme">
                          {{ partQuoteDetail.unit }}
                        </td>
                        <td class="text-center text-theme">
                          {{ partQuoteDetail.unitPrice }}
                        </td>
                        <td class="text-center text-theme">
                          {{ partQuoteDetail.value | currency: 'USD':'symbol':'0.0-3' }}
                        </td>
                      </tr>
                      <tr>
                        <td class="text-theme">
                          <a
                            class="link over-ride p-0 m-0"
                            *ngIf="!part?.manualPricingAllowed"
                            (click)="startOverrideForm()"
                            >Override</a
                          >
                        </td>
                        <td class="text-center text-theme"></td>
                        <td *ngIf="!part?.isNoBid" class="text-center font-weight-bold text-theme">
                          Subtotal
                        </td>
                        <td *ngIf="part?.isNoBid" class="text-center font-weight-bold text-orange">
                          No Bid
                        </td>
                        <td class="text-center font-weight-bold text-theme">
                          {{ partQuote?.totalCost | currency: 'USD':'symbol':'0.0-3' }}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </ng-container>
                <ng-container *ngSwitchDefault>
                  <table [formGroup]="dynamicForm" class="table table-borderless pricing-table w-75 m-0">
                    <thead>
                      <tr>
                        <th class="">Line Item</th>
                        <th class="text-center">Unit Count</th>
                        <th class="text-center">Unit Price</th>
                        <th class="text-center">Line Item Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngIf="prices?.controls?.length > 0">
                        <ng-container *ngFor="let item of prices.controls; let i = index">
                          <tr [formGroup]="item">
                            <td class="font-weight-bold text-theme text-center">
                              {{ getInvoiceItem(item.get('invoiceItemId').value) }}
                            </td>
                            <td class="font-weight-bold text-theme text-center">
                              <ng-container *ngIf="stage === 'confirm'">
                                {{ item.get('unit').value }}
                              </ng-container>
                              <ng-container *ngIf="stage === 'edit'">
                                <input
                                  digitOnly
                                  [min]="0"
                                  [step]="1"
                                  type="number"
                                  class="price-input"
                                  formControlName="unit"
                                />
                              </ng-container>
                            </td>
                            <td class="font-weight-bold text-theme text-center">
                              <ng-container *ngIf="stage === 'confirm'">
                                {{ item.get('unitPrice').value }}
                              </ng-container>
                              <ng-container *ngIf="stage === 'edit'">
                                <input
                                  digitOnly
                                  decimal="true"
                                  pattern="[0-9]+([.][0-9]+)?"
                                  decimalSeparator="."
                                  [min]="0"
                                  step="0.1"
                                  type="number"
                                  class="price-input"
                                  formControlName="unitPrice"
                                />
                              </ng-container>
                            </td>
                            <td class="font-weight-bold text-theme text-center">
                              {{ calcLineItemCost(item) | currency: 'USD':'symbol':'0.0-3' }}
                            </td>
                          </tr>
                        </ng-container>
                      </ng-container>
                      <tr>
                        <td class="text-theme-green">
                          <ng-container *ngIf="stage === 'edit'">
                            <span>See the recommended price</span>
                          </ng-container>
                          <ng-container *ngIf="stage === 'confirm'">
                            <a *ngIf="stage === 'confirm'" (click)="changeStage('edit')" class="edit-price">
                              Edit Price
                            </a>
                          </ng-container>
                        </td>
                        <td class="text-center text-theme"></td>
                        <td class="text-center font-weight-bold text-theme">
                          Subtotal
                        </td>
                        <td class="font-weight-bold text-theme text-center">
                          {{ findLineItemTotalCost() | currency: 'USD':'symbol':'0.0-3' }}
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr *ngIf="stage === 'edit'">
                        <td colspan="4" class="text-right">
                          <button class="btn orange-btn" (click)="changeStage('unset'); resetDynamicForm()">
                            Cancel
                          </button>
                          <button class="btn green-btn" (click)="changeStage('confirm')">
                            Save
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="stage === 'confirm'" class="confirm-row">
                        <td colspan="2">
                          Apply this final price to part?
                        </td>
                        <td colspan="2" class="text-right">
                          <button class="btn orange-btn" (click)="changeStage('unset'); resetDynamicForm()">
                            No
                          </button>
                          <button class="btn green-btn" (click)="openModal(confirm, 'confirm')">
                            Yes
                          </button>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </ng-container>
              </ng-container>
            </ng-container>
            <ng-template #pricingSetting>
              <form [formGroup]="pricingForm">
                <table class="table table-borderless pricing-table w-75 m-0">
                  <colgroup>
                    <col width="25%" />
                    <col width="25%" />
                    <col width="25%" />
                    <col width="25%" />
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="">Line Item</th>
                      <th class="text-center">Unit Count</th>
                      <th class="text-center">Unit Price</th>
                      <th class="text-center">Line Item Cost</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="font-weight-bold">Tooling</td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input type="number" class="price-input" formControlName="toolingUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="toolingUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.toolingUnitCount }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input
                              digitOnly
                              decimal="true"
                              pattern="[0-9]+([.][0-9]+)?"
                              decimalSeparator="."
                              [min]="0"
                              step="0.1"
                              type="number"
                              class="price-input"
                              formControlName="toolingUnitPrice"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="toolingUnitPrice" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.toolingUnitPrice }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <!-- <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                            /> -->
                            {{
                              pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                                | currency: 'USD':'symbol':'0.0-3'
                            }}
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <!-- <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                            /> -->
                            {{
                              pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                                | currency: 'USD':'symbol':'0.0-3'
                            }}
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.toolingLineItemCost }}</ng-container>
                        </ng-container>
                      </td>
                    </tr>
                    <tr>
                      <td class="font-weight-bold">Parts</td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input
                              type="number"
                              digitOnly
                              [min]="0"
                              [step]="1"
                              type="number"
                              class="price-input"
                              formControlName="partsUnitCount"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="partsUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.partsUnitCount }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input
                              digitOnly
                              decimal="true"
                              pattern="[0-9]+([.][0-9]+)?"
                              decimalSeparator="."
                              [min]="0"
                              step="0.1"
                              type="number"
                              class="price-input"
                              formControlName="partsUnitPrice"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="partsUnitPrice" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{
                            pricingForm.value.partsUnitPrice | currency: 'USD':'symbol':'0.0-3'
                          }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <!-- <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice"
                            /> -->
                            {{
                              pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice
                                | currency: 'USD':'symbol':'0.0-3'
                            }}
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <!-- <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice"
                            /> -->
                            {{
                              pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice
                                | currency: 'USD':'symbol':'0.0-3'
                            }}
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{
                            pricingForm.value.partsLineItemCost | currency: 'USD':'symbol':'0.0-3'
                          }}</ng-container>
                        </ng-container>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2">
                        <!-- <a
                    *ngIf="stage === 'edit'"
                    (click)="openModal(recommendation, 'recommended')"
                    class="show-recommended"
                    >See Recommended Price</a
                  > -->
                        <a *ngIf="stage === 'confirm'" (click)="changeStage('edit')" class="edit-price">Edit Price</a>
                      </td>
                      <td class="text-center font-weight-bold" *ngIf="!part?.isNoBid">Subtotal</td>
                      <td class="text-center font-weight-bold text-orange" *ngIf="part?.isNoBid">No Bid</td>
                      <td class="text-center font-weight-bold" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <!-- <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="
                                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                              "
                            /> -->
                            {{
                              pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                                | currency: 'USD':'symbol':'0.0-3'
                            }}
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <!-- <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="
                                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                              "
                            /> -->
                            {{
                              pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                                | currency: 'USD':'symbol':'0.0-3'
                            }}
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.totalCost }}</ng-container>
                        </ng-container>
                      </td>
                    </tr>
                    <tr *ngIf="stage === 'unset' && !this.pricingForm.value.noBid && !part?.isNoBid" class="unset-row">
                      <td colspan="3">
                        Please edit the prices manually
                      </td>
                      <td class="text-center">
                        <button class="btn orange-btn" (click)="changeStage('edit')">
                          Edit Price
                        </button>
                      </td>
                    </tr>

                    <tr
                      *ngIf="stage === 'unset' && this.pricingForm.value.noBid && !this.part?.isNoBid"
                      class="edit-row"
                    >
                      <td colspan="4" class="text-right">
                        <button class="btn orange-btn" (click)="this.pricingForm.controls.noBid.setValue(false)">
                          Cancel
                        </button>
                        <button class="btn green-btn" (click)="openModal(confirmNoBid, 'null')">
                          Save
                        </button>
                      </td>
                    </tr>

                    <tr *ngIf="stage === 'unset' && !part?.isNoBid">
                      <td colspan="3" class="no-bid">
                        <div [formGroup]="pricingForm" class="form-check form-group theme ">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            formControlName="noBid"
                            value="noBid"
                            id="noBid"
                          />
                          <label class="form-check-label mt-1" for="noBid">
                            No Bid
                          </label>
                        </div>
                      </td>
                    </tr>

                    <tr *ngIf="stage === 'edit'" class="edit-row">
                      <td colspan="4" class="text-right">
                        <button class="btn orange-btn" (click)="changeStage('unset')">
                          Cancel
                        </button>
                        <button class="btn green-btn" (click)="changeStage('confirm')">
                          Save
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="stage === 'confirm'" class="confirm-row">
                      <td colspan="2">
                        Apply this Manual Price to Part?
                      </td>
                      <td colspan="2" class="text-right">
                        <button class="btn orange-btn" (click)="changeStage('unset')">
                          No
                        </button>
                        <button class="btn green-btn" (click)="openModal(confirm, 'confirm')">
                          Yes
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </form>
            </ng-template>
          </div>
        </ng-template>
      </ngb-tab>
      <ngb-tab title="Shipping Detail">
        <ng-template ngbTabContent>
          <div class="table p-4">
            <table class="shipping-table w-75 m-0">
              <thead>
                <tr>
                  <th class="text-center">Shipment</th>
                  <th class="text-center">QTY</th>
                  <th>Address</th>
                  <th class="text-center">Target Delivery</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-center">{{ 1 }}</td>
                  <td class="text-center">{{ part?.quantity }}</td>
                  <td>{{ getShippingAddress(part?.shippingAddress) }}</td>
                  <td class="text-center">
                    {{ part?.targetDeliveryDate | date }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-template>
      </ngb-tab>

      <ngb-tab title="Customer Information">
        <ng-template ngbTabContent>
          <div class="d-flex text-theme m-5 customerInfo">
            <img src="../../../../../../assets/image/user-profile-icon.png" alt="" height="60px" width="60px" />
            <div class="pl-3 customer-details">
              <p class="mb-1">
                Customer : <span class=" font-weight-bold value">{{ customer?.user?.companyName || '-' }}</span>
              </p>
              <p class="mb-1">
                Customer ID: <span class=" font-weight-bold value">{{ customer?.id || '-' }}</span>
              </p>
              <p class="mb-1">
                Customer Name: <span class=" font-weight-bold value">{{ customer?.name || '-' }}</span>
              </p>
              <p class="mb-1">
                Contact Email : <span class=" font-weight-bold value">{{ customer?.user?.email || '-' }}</span>
              </p>
              <p class="mb-1">
                Contact Phone : <span class=" font-weight-bold value">{{ customer?.phoneNo || '-' }}</span>
              </p>
            </div>
          </div>
        </ng-template>
      </ngb-tab>
    </ngb-tabset>
    <!-- /TAB -->
  </div>

  <div class="col-3" *ngIf="part && customer && customer?.user?.id">
    <app-plain-chat [value]="chat" [participants]="[customer.user.id]" [type]="chatType.PART_NOTE" [id]="part.id">
    </app-plain-chat>
  </div>
</div>

<ng-template #recommendation let-modal>
  <app-recommended-pricing (close)="onRecommendModalClose($event)"></app-recommended-pricing>
</ng-template>

<ng-template #confirm let-modal>
  <div class="modal-container">
    <div class="modal-header w-100 d-flex justify-content-center align-items-center">
      <h5 class="modal-title text-center" id="modal-basic-title">
        Confirming {{ part.manualPricingAllowed ? 'Manual' : 'Final' }} Price for Part
      </h5>
    </div>
    <div class="modal-body px-5 py-3">
      <p class="text-center">
        Once confirmed, the {{ part.manualPricingAllowed ? 'manual' : 'final' }} price will be issued to the
        customer.<br />Are you sure?
      </p>
      <table class="w-100 table table-borderless pricing-table">
        <thead>
          <tr>
            <th class="">Line Item</th>
            <th class="text-center">Unit Count</th>
            <th class="text-center">Unit Price</th>
            <th class="text-center">LineItemCost</th>
          </tr>
        </thead>
        <tbody *ngIf="part.manualPricingAllowed; else defaultOverrideForm">
          <tr>
            <td class="font-weight-bold">Tooling</td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitCount }}
            </td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitPrice }}
            </td>
            <td class="text-center">
              {{
                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                  | currency: 'USD':'symbol':'0.0-3'
              }}
            </td>
          </tr>
          <tr>
            <td class="font-weight-bold">Parts</td>
            <td class="text-center">{{ pricingForm.value.partsUnitCount }}</td>
            <td class="text-center">{{ pricingForm.value.partsUnitPrice }}</td>
            <td class="text-center">
              {{
                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice | currency: 'USD':'symbol':'0.0-3'
              }}
            </td>
          </tr>
          <tr>
            <td class="text-center"></td>
            <td class="text-center"></td>
            <td class="text-center font-weight-bold">Subtotal</td>
            <td class="text-center font-weight-bold">
              {{
                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                  pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                  | currency: 'USD':'symbol':'0.0-3'
              }}
            </td>
          </tr>
        </tbody>
      </table>
      <span class="additional">*Shipping: Included</span>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn orange-btn" (click)="modal.close()">Cancel</button>
      <button class="btn green-btn" (click)="onSave()">Confirm</button>
    </div>
  </div>
</ng-template>

<ng-template #defaultOverrideForm>
  <tbody>
    <ng-container *ngIf="prices?.controls?.length > 0">
      <ng-container *ngFor="let item of prices.controls; let i = index">
        <tr [formGroup]="item">
          <td class="font-weight-bold text-center text-theme">
            {{ getInvoiceItem(item.get('invoiceItemId').value) }}
          </td>
          <td class="font-weight-bold text-center text-theme">
            {{ item.get('unit').value }}
          </td>
          <td class="font-weight-bold text-center text-theme">
            {{ item.get('unitPrice').value }}
          </td>
          <td class="font-weight-bold text-center text-theme">
            {{ calcLineItemCost(item) | currency: 'USD':'symbol':'0.0-3' }}
          </td>
        </tr>
      </ng-container>
    </ng-container>
    <tr>
      <td class="text-theme-green"></td>
      <td class="text-center text-theme"></td>
      <td class="text-center font-weight-bold text-theme">
        Subtotal
      </td>
      <td class="font-weight-bold text-theme text-center">
        {{ findLineItemTotalCost() | currency: 'USD':'symbol':'0.0-3' }}
      </td>
    </tr>
  </tbody>
</ng-template>

<ng-template #refreshWindow let-modal>
  <div class="modal-container">
    <div class="modal-header w-100 d-flex justify-content-center align-items-center">
      <h5 class="modal-title text-center">
        Customer has changed the part details
      </h5>
    </div>
    <div class="modal-body px-5 py-3" ngbAutofocus>
      <p class="text-center">
        Please refresh your screen to get latest part information
      </p>
      <div class="d-flex justify-content-center align-items-center">
        <button class="refresh-btn btn btn-theme w-auto text-theme" (click)="refresh()">
          <i class="fas fa-redo-alt"></i>
        </button>
      </div>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn green-btn" (click)="refresh()">Ok</button>
    </div>
  </div>
</ng-template>

<ng-template #confirmNoBid let-modal>
  <div class="modal-container">
    <div class="modal-header w-100 d-flex justify-content-center align-items-center">
      <h5 class="modal-title text-center">
        No Bid Confirmation
      </h5>
    </div>
    <div class="modal-body px-5 py-3" ngbAutofocus>
      <p class="text-center">
        Are you sure you want to make Part {{ part.rfqMedia.projectRfqId }}.{{ part.id }} to No Quote Status ?
      </p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn orange-btn" (click)="modal.close()">Cancel</button>
      <button class="btn green-btn" (click)="noBidConfirm()">Confirm</button>
    </div>
  </div>
</ng-template>
