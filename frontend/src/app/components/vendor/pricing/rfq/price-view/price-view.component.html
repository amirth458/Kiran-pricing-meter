<div class="col-12 d-flex flex-row p-0">
  <div class="col-9 p-0">
    <!-- TABLE -->
    <div class="col-12 theme-table p-0">
      <ag-grid-angular
        class="ag-theme-balham price-grid w-100 h-100"
        [class.empty-grid]="rowData?.length === 0"
        [rowData]="rowData"
        [gridOptions]="gridOptions"
        [domLayout]="'autoHeight'"
        (gridReady)="onGridReady($event)"
      >
      </ag-grid-angular>
    </div>
    <!-- /TABLE -->
    <!-- TAB -->
    <ngb-tabset class="col-12  d-block mt-4 p-0 border" [destroyOnHide]="false">
      <ngb-tab title="Price Detail">
        <ng-template ngbTabContent>
          <div class="table p-4">
            <ng-container
              *ngIf="!part?.manualPricingAllowed || part?.partStatusType.id === 3 || partQuote; else pricingSetting"
            >
              <ng-container [ngSwitch]="stage">
                <ng-container *ngSwitchCase="'unset'">
                  <table class="table table-borderless pricing-table w-75 m-0">
                    <thead>
                      <tr>
                        <th class="">Line Item</th>
                        <th class="text-center">Unit Count</th>
                        <th class="text-center">Unit Price</th>
                        <th class="text-center">Line Item Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let partQuoteDetail of partQuote?.partQuoteDetails">
                        <td class="font-weight-bold text-theme">
                          {{ getInvoiceItem(partQuoteDetail.invoiceItemId) }}
                        </td>
                        <td class="text-center text-theme">
                          {{ partQuoteDetail.unit }}
                        </td>
                        <td class="text-center text-theme">
                          {{ partQuoteDetail.unitPrice }}
                        </td>
                        <td class="text-center text-theme">
                          {{ partQuoteDetail.value }}
                        </td>
                      </tr>
                      <tr>
                        <td class="text-theme">
                          <a
                            class="link over-ride p-0 m-0"
                            *ngIf="!part?.manualPricingAllowed"
                            (click)="startOverrideForm()"
                            >Override</a
                          >
                        </td>
                        <td class="text-center text-theme"></td>
                        <td class="text-center font-weight-bold text-theme">
                          Subtotal
                        </td>
                        <td class="text-center font-weight-bold text-theme">
                          {{ partQuote?.totalCost | currency: 'USD':'symbol':'0.0-3' }}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </ng-container>
                <ng-container *ngSwitchDefault>
                  <table [formGroup]="dynamicForm" class="table table-borderless pricing-table w-75 m-0">
                    <thead>
                      <tr>
                        <th class="">Line Item</th>
                        <th class="text-center">Unit Count</th>
                        <th class="text-center">Unit Price</th>
                        <th class="text-center">Line Item Cost</th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngIf="prices?.controls?.length > 0">
                        <ng-container *ngFor="let item of prices.controls; let i = index">
                          <tr [formGroup]="item">
                            <td class="font-weight-bold text-theme">
                              {{ getInvoiceItem(item.get('invoiceItemId').value) }}
                            </td>
                            <td class="font-weight-bold text-theme">
                              <input type="number" class="price-input" formControlName="unit" />
                            </td>
                            <td class="font-weight-bold text-theme">
                              <input type="number" class="price-input" formControlName="unitPrice" />
                            </td>
                            <td class="font-weight-bold text-theme">
                              {{ calcLineItemCost(item) | currency: 'USD':'symbol':'0.0-3' }}
                            </td>
                          </tr>
                        </ng-container>
                      </ng-container>
                      <tr>
                        <td class="text-theme-green">
                          <span>See the recommended price</span>
                        </td>
                        <td class="text-center text-theme"></td>
                        <td class="text-center font-weight-bold text-theme">
                          Subtotal
                        </td>
                        <td class="font-weight-bold text-theme">
                          {{ findLineItemTotalCost() | currency: 'USD':'symbol':'0.0-3' }}
                        </td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr *ngIf="stage === 'edit'">
                        <td colspan="4" class="text-right">
                          <button class="btn orange-btn" (click)="changeStage('unset'); resetDynamicForm()">
                            Cancel
                          </button>
                          <button class="btn green-btn" (click)="changeStage('confirm')">
                            Save
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="stage === 'confirm'" class="confirm-row">
                        <td colspan="2">
                          Apply this final price to part?
                        </td>
                        <td colspan="2" class="text-right">
                          <button class="btn orange-btn" (click)="changeStage('unset'); resetDynamicForm()">
                            No
                          </button>
                          <button class="btn green-btn">
                            Yes
                          </button>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </ng-container>
              </ng-container>
            </ng-container>
            <ng-template #pricingSetting>
              <form [formGroup]="pricingForm">
                <table class="table table-borderless pricing-table w-75 m-0">
                  <colgroup>
                    <col width="25%" />
                    <col width="25%" />
                    <col width="25%" />
                    <col width="25%" />
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="">Line Item</th>
                      <th class="text-center">Unit Count</th>
                      <th class="text-center">Unit Price</th>
                      <th class="text-center">Line Item Cost</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="font-weight-bold">Tooling</td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input type="number" readonly class="price-input" formControlName="toolingUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="toolingUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.toolingUnitCount }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input type="number" class="price-input" formControlName="toolingUnitPrice" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="toolingUnitPrice" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.toolingUnitPrice }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input
                              type="number"
                              readonly
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.toolingLineItemCost }}</ng-container>
                        </ng-container>
                      </td>
                    </tr>
                    <tr>
                      <td class="font-weight-bold">Parts</td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input type="number" class="price-input" formControlName="partsUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="partsUnitCount" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.partsUnitCount }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input type="number" class="price-input" formControlName="partsUnitPrice" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input type="number" readonly class="price-input" formControlName="partsUnitPrice" />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.partsUnitPrice }}</ng-container>
                        </ng-container>
                      </td>
                      <td class="text-center" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input
                              type="number"
                              readonly
                              class="price-input"
                              readonly
                              [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice"
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.partsLineItemCost }}</ng-container>
                        </ng-container>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2">
                        <!-- <a
                    *ngIf="stage === 'edit'"
                    (click)="openModal(recommendation, 'recommended')"
                    class="show-recommended"
                    >See Recommended Price</a
                  > -->
                        <a *ngIf="stage === 'confirm'" (click)="changeStage('edit')" class="edit-price">Edit Price</a>
                      </td>
                      <td class="text-center font-weight-bold">Subtotal</td>
                      <td class="text-center font-weight-bold" [ngClass]="{ unset: stage === 'unset' }">
                        <ng-container [ngSwitch]="stage">
                          <ng-container *ngSwitchCase="'edit'">
                            <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="
                                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                              "
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'confirm'">
                            <input
                              type="number"
                              class="price-input"
                              readonly
                              [value]="
                                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
                              "
                            />
                          </ng-container>
                          <ng-container *ngSwitchCase="'unset'">-</ng-container>
                          <ng-container *ngSwitchDefault>{{ pricingForm.value.totalCost }}</ng-container>
                        </ng-container>
                      </td>
                    </tr>
                    <tr *ngIf="stage === 'unset'" class="unset-row">
                      <td colspan="3">
                        Please edit the prices manually
                      </td>
                      <td class="text-center">
                        <button class="btn orange-btn" (click)="changeStage('edit')">
                          Edit Price
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="stage === 'edit'" class="edit-row">
                      <td colspan="4" class="text-right">
                        <button class="btn orange-btn" (click)="changeStage('unset')">
                          Cancel
                        </button>
                        <button class="btn green-btn" (click)="changeStage('confirm')">
                          Save
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="stage === 'confirm'" class="confirm-row">
                      <td colspan="2">
                        Apply this Manual Price to Part?
                      </td>
                      <td colspan="2" class="text-right">
                        <button class="btn orange-btn" (click)="changeStage('unset')">
                          No
                        </button>
                        <button class="btn green-btn" (click)="openModal(confirm, 'confirm')">
                          Yes
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </form>
            </ng-template>
          </div>
        </ng-template>
      </ngb-tab>
      <ngb-tab title="Shipping Detail">
        <ng-template ngbTabContent>
          <div class="table p-4">
            <table class="shipping-table w-75 m-0">
              <thead>
                <tr>
                  <th class="text-center">Shipment</th>
                  <th class="text-center">QTY</th>
                  <th>Address</th>
                  <th class="text-center">Target Delivery</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-center">{{ 1 }}</td>
                  <td class="text-center">{{ part?.quantity }}</td>
                  <td>{{ getShippingAddress(part?.shippingAddress) }}</td>
                  <td class="text-center">
                    {{ part?.targetDeliveryDate | date }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-template>
      </ngb-tab>
    </ngb-tabset>
    <!-- /TAB -->
  </div>

  <div class="col-3">
    <div class="col-12 border p-0 shadow d-flex flex-column">
      <h5 class="text-theme-green align-top text-center m-0 pt-3 pb-3 shadow">
        Notes
      </h5>
      <div class="d-flex flex-grow-1 flex-column message-container" #scroller (scroll)="onScroll()">
        <ng-container *ngIf="partNoteView?.messages?.length > 0">
          <div class="participant-chat text-left" *ngFor="let m of partNoteView.messages">
            <span class="text-theme-green">{{ m.user.firstName || '' }} {{ m.user.lastName || '' }}</span>
            <p>{{ m.message || '' }}</p>
          </div>
        </ng-container>
        <ng-container *ngIf="partNoteView?.messages?.length === 0">
          <div class="participant-chat text-left">
            No chats found
          </div>
        </ng-container>
        <!--
        <div class="date-separator">
          <div class="dt-value">
            Mon, 20 2020
            <span class="time">14.35</span>
          </div>
        </div>

        <div class="participant-chat text-right">
          <span class="text-theme">Admin</span>
          <p>Ok Approved</p>
        </div>

        <div class="participant-chat text-left">
          <span class="text-theme-green">Cullen</span>
          <p>Hello I've submitted PO documents</p>
        </div>

        <div class="date-separator">
          <div class="dt-value">
            Mon, 20 2020
            <span class="time">14.35</span>
          </div>
        </div>

        <div class="participant-chat text-right">
          <span class="text-theme">Admin</span>
          <p>Ok Approved</p>
        </div>
        -->
      </div>
      <form class="pl-2 pr-2 pt-3 pb-3 w-100 align-bottom" [formGroup]="noteFormGroup">
        <hr class="m-0" />
        <div class="form-row">
          <div class="form-group theme col-12 m-0">
            <label class="w-100">
              Note
              <textarea
                class="form-control note-input"
                rows="2"
                formControlName="note"
                (keyup.enter)="sendNote($event)"
              ></textarea>
            </label>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group theme col-12 m-0 d-flex justify-content-center">
            <button class="btn btn-white pl-4 pr-4" [disabled]="!noteFormGroup.valid" (click)="addNote()">
              {{ loadingNote ? 'Submitting Note' : 'Add Note' }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<ng-template #recommendation let-modal>
  <app-recommended-pricing (close)="onRecommendModalClose($event)"></app-recommended-pricing>
</ng-template>

<ng-template #confirm let-modal>
  <div class="modal-container">
    <div class="modal-header w-100">
      <h5 class="modal-title text-center" id="modal-basic-title">
        Confirming Manual Price for Part
      </h5>
    </div>
    <div class="modal-body px-5 py-3">
      <p class="text-center">Once confirmed, the manual price will be issued to the customer.<br />Are you sure?</p>
      <table class="w-100 table table-borderless pricing-table">
        <thead>
          <tr>
            <th class="">Line Item</th>
            <th class="text-center">Unit Count</th>
            <th class="text-center">Unit Price</th>
            <th class="text-center">LineItemCost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="font-weight-bold">Tooling</td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitCount }}
            </td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitPrice }}
            </td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice }}
            </td>
          </tr>
          <tr>
            <td class="font-weight-bold">Parts</td>
            <td class="text-center">{{ pricingForm.value.partsUnitCount }}</td>
            <td class="text-center">{{ pricingForm.value.partsUnitPrice }}</td>
            <td class="text-center">
              {{ pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice }}
            </td>
          </tr>
          <tr>
            <td class="text-center"></td>
            <td class="text-center"></td>
            <td class="text-center font-weight-bold">Subtotal</td>
            <td class="text-center font-weight-bold">
              {{
                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                  pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
              }}
            </td>
          </tr>
        </tbody>
      </table>
      <span class="additional">*Shipping: Included</span>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn orange-btn" (click)="modal.close()">Cancel</button>
      <button class="btn green-btn" (click)="onSave()">Confirm</button>
    </div>
  </div>
</ng-template>
