<div class="row">
  <div class="col-12 theme-table">
    <ag-grid-angular
      class="ag-theme-balham w-100 h-100"
      [rowData]="rowData"
      [gridOptions]="gridOptions"
      (gridReady)="onGridReady($event)"
    ></ag-grid-angular>
  </div>
</div>
<div class="row mt-4">
  <div class="col-md-6 col-sm-12">
    <ng-container class="table">
      <h6 class="header mb-3"><strong>Price Detail</strong></h6>
      <table
        class="w-100 table table-borderless pricing-table"
        *ngIf="
          !part?.manualPricingAllowed || part?.partStatusType.id === 3 || partQuote;
          else pricingSetting
        "
      >
        <thead>
          <tr>
            <th class="">Line Item</th>
            <th class="text-center">Unit Count</th>
            <th class="text-center">Unit Price</th>
            <th class="text-center">Line Item Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let partQuoteDetail of partQuote?.partQuoteInvoiceItemDetails"
          >
            <td class="font-weight-bold">
              {{ getInvoiceItem(partQuoteDetail.invoiceItemId) }}
            </td>
            <td class="text-center">{{ partQuoteDetail.invoiceItemId === 3 ? part.quantity : 1 }}</td>
            <td class="text-center">{{ (partQuoteDetail.invoiceItemId === 3 ? partQuoteDetail.invoiceItemCost / (part.quantity ? part.quantity : 1) : partQuoteDetail.invoiceItemCost) | number:'1.0-2' }}</td>
            <td class="text-center">{{ partQuoteDetail.invoiceItemCost | number:'0.0-3' }}</td>
          </tr>
          <tr>
            <td class="text-center"></td>
            <td class="text-center"></td>
            <td class="text-center font-weight-bold">Subtotal</td>
            <td class="text-center font-weight-bold">
              {{ partQuote?.totalCost | currency:'USD':'symbol':'0.0-3' }}
            </td>
          </tr>
        </tbody>
      </table>
      <ng-template #pricingSetting>
        <form [formGroup]="pricingForm">
          <table class="w-100 table table-borderless pricing-table a">
            <colgroup>
              <col width="25%" />
              <col width="25%" />
              <col width="25%" />
              <col width="25%" />
            </colgroup>
            <thead>
              <tr>
                <th class="">Line Item</th>
                <th class="text-center">Unit Count</th>
                <th class="text-center">Unit Price</th>
                <th class="text-center">Line Item Cost</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="font-weight-bold">Tooling</td>
                <td
                  class="text-center"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        formControlName="toolingUnitCount"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        readonly
                        class="price-input"
                        formControlName="toolingUnitCount"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.toolingUnitCount
                    }}</ng-container>
                  </ng-container>
                </td>
                <td
                  class="text-center"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        formControlName="toolingUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        readonly
                        class="price-input"
                        formControlName="toolingUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.toolingUnitPrice
                    }}</ng-container>
                  </ng-container>
                </td>
                <td
                  class="text-center"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        readonly
                        [value]="pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        readonly
                        class="price-input"
                        readonly
                        [value]="pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.toolingLineItemCost
                    }}</ng-container>
                  </ng-container>
                </td>
              </tr>
              <tr>
                <td class="font-weight-bold">Parts</td>
                <td
                  class="text-center"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        formControlName="partsUnitCount"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        readonly
                        class="price-input"
                        formControlName="partsUnitCount"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.partsUnitCount
                    }}</ng-container>
                  </ng-container>
                </td>
                <td
                  class="text-center"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        formControlName="partsUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        readonly
                        class="price-input"
                        formControlName="partsUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.partsUnitPrice
                    }}</ng-container>
                  </ng-container>
                </td>
                <td
                  class="text-center"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        readonly
                        [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        readonly
                        class="price-input"
                        readonly
                        [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.partsLineItemCost
                    }}</ng-container>
                  </ng-container>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <a
                    *ngIf="stage === 'edit'"
                    (click)="openModal(recommendation, 'recommended')"
                    class="show-recommended"
                    >See Recommended Price</a
                  >
                  <a
                    *ngIf="stage === 'confirm'"
                    (click)="changeStage('edit')"
                    class="edit-price"
                    >Edit Price</a
                  >
                </td>
                <td class="text-center font-weight-bold">Subtotal</td>
                <td
                  class="text-center font-weight-bold"
                  [ngClass]="{ unset: stage === 'unset' }"
                >
                  <ng-container [ngSwitch]="stage">
                    <ng-container *ngSwitchCase="'edit'">
                      <input
                        type="number"
                        class="price-input"
                        readonly
                        [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice + pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'confirm'">
                      <input
                        type="number"
                        class="price-input"
                        readonly
                        [value]="pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice + pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice"
                      />
                    </ng-container>
                    <ng-container *ngSwitchCase="'unset'">-</ng-container>
                    <ng-container *ngSwitchDefault>{{
                      pricingForm.value.totalCost
                    }}</ng-container>
                  </ng-container>
                </td>
              </tr>
              <tr *ngIf="stage === 'unset'" class="unset-row">
                <td colspan="3">
                  Please edit the prices manually
                </td>
                <td class="text-center">
                  <button class="btn orange-btn" (click)="changeStage('edit')">
                    Edit Price
                  </button>
                </td>
              </tr>
              <tr *ngIf="stage === 'edit'" class="edit-row">
                <td colspan="4" class="text-right">
                  <button class="btn orange-btn" (click)="changeStage('unset')">
                    Cancel
                  </button>
                  <button
                    class="btn green-btn"
                    (click)="changeStage('confirm')"
                  >
                    Save
                  </button>
                </td>
              </tr>
              <tr *ngIf="stage === 'confirm'" class="confirm-row">
                <td colspan="2">
                  Apply this Manual Price to Part?
                </td>
                <td colspan="2" class="text-right">
                  <button class="btn orange-btn" (click)="changeStage('unset')">
                    No
                  </button>
                  <button
                    class="btn green-btn"
                    (click)="openModal(confirm, 'confirm')"
                  >
                    Yes
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </form>
      </ng-template>
    </ng-container>
  </div>
  <div class="col-md-6 col-sm-12">
    <div class="table">
      <h6 class="header mb-3"><strong>Shipping Detail</strong></h6>
      <table class="w-100 shipping-table table-sm">
        <thead>
          <tr>
            <th>Shipment</th>
            <th>QTY</th>
            <th>Address</th>
            <th>Target Delivery</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let shipping of part?.order?.partList; index as i">
            <td class="text-center">{{ i + 1 }}</td>
            <td class="text-center">{{ shipping.quantity }}</td>
            <td>{{ getShippingAddress(shipping.shippingAddress) }}</td>
            <td>{{ shipping.targetDeliveryDate | date }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<ng-template #recommendation let-modal>
  <app-recommended-pricing
    (close)="onRecommendModalClose($event)"
  ></app-recommended-pricing>
</ng-template>

<ng-template #confirm let-modal>
  <div class="modal-container">
    <div class="modal-header w-100">
      <h5 class="modal-title text-center" id="modal-basic-title">
        Confirming Manual Price for Part
      </h5>
    </div>
    <div class="modal-body px-5 py-3">
      <p class="text-center">
        Once confirmed, the manual price will be issued to the customer.<br />Are
        you sure?
      </p>
      <table class="w-100 table table-borderless pricing-table">
        <thead>
          <tr>
            <th class="">Line Item</th>
            <th class="text-center">Unit Count</th>
            <th class="text-center">Unit Price</th>
            <th class="text-center">LineItemCost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="font-weight-bold">Tooling</td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitCount }}
            </td>
            <td class="text-center">
              {{ pricingForm.value.toolingUnitPrice }}
            </td>
            <td class="text-center">{{ pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice }}</td>
          </tr>
          <tr>
            <td class="font-weight-bold">Parts</td>
            <td class="text-center">{{ pricingForm.value.partsUnitCount }}</td>
            <td class="text-center">{{ pricingForm.value.partsUnitPrice }}</td>
            <td class="text-center">{{ pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice }}</td>
          </tr>
          <tr>
            <td class="text-center"></td>
            <td class="text-center"></td>
            <td class="text-center font-weight-bold">Subtotal</td>
            <td class="text-center font-weight-bold">
              {{
                pricingForm.value.partsUnitCount * pricingForm.value.partsUnitPrice +
                pricingForm.value.toolingUnitCount * pricingForm.value.toolingUnitPrice
              }}
            </td>
          </tr>
        </tbody>
      </table>
      <span class="additional">*Shipping: Included</span>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn orange-btn" (click)="modal.close()">Cancel</button>
      <button class="btn green-btn" (click)="onSave()">Confirm</button>
    </div>
  </div>
</ng-template>
