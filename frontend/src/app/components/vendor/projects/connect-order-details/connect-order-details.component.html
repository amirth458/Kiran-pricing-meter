<div class="wrapper text-theme">
  <div class="part-list">
    <div class="w-100 row">
      <h6 class="col-12 pl-0 text-theme">
        Project Details
        <span
          class="font-sm mx-4 font-weight-bold text-light-blue"
          *ngIf="(projectDetails?.parts)[0]?.subContractorsAllowed"
          >Sub-Contractors Allowed</span
        >
        <span
          class="font-sm mx-4 font-weight-bold text-light-blue"
          *ngIf="(projectDetails?.parts)[0]?.requestProdexDirectBid"
          >Request ProdEX Direct Bid</span
        >
        <span
          *ngIf="projectDetails?.parts"
          class="ml-3 font-sm cursor-pointer font-weight-normal hover-underline"
          (click)="showPartDetails = !showPartDetails"
        >
          See <ng-container *ngIf="showPartDetails">less</ng-container>
          <ng-container *ngIf="!showPartDetails">more</ng-container> details
        </span>
      </h6>

      <ng-container *ngIf="!showPartDetails">
        <app-part-list [showRefFile]="true" [parts]="projectDetails?.parts"></app-part-list>
      </ng-container>
      <div *ngIf="showPartDetails && unitOptions" class="part-details w-100">
        <app-part-detail
          *ngFor="let part of projectDetails?.parts"
          [connectView]="true"
          [partId]="part.partId"
          [unitOptions]="unitOptions"
        >
        </app-part-detail>
      </div>
    </div>
    <div *ngIf="orderInfo?.customerOrder?.notes" class="d-flex flex-column">
      <h6 class="text-theme ins-title">Additional Guidance</h6>
      <div class="d-flex flex-row p-0 form-group theme w-100">
        <textarea
          [value]="orderInfo?.customerOrder?.notes"
          disabled
          class="form-control release-notes text-theme"
          rows="3"
        >
        </textarea>
      </div>
    </div>
  </div>

  <div class="my-4 prodex-supplier">
    <div class="heading d-flex justify-content-between align-items-end mb-3">
      <h6>
        Prodex Supplier
        <span class="font-weight-normal font-sm"
          >(ProdEX Supplier Requested - {{ projectDetails?.minimumProdexSuppliers }})</span
        >

        <span
          class="font-sm ml-4 text-center text-orange"
          *ngIf="
            projectDetails?.minimumProdexSuppliers &&
            projectDetails?.prodexSuppliers.length &&
            projectDetails?.minimumProdexSuppliers > selectableProdexSuppliers
          "
        >
          Not all ProdEX suppliers available. Please check ProdEX supplier has valid ShopSight 360 plus subscription.
        </span>
      </h6>
      <div
        *ngIf="firstTimeRelease && this.pageType === 'release-queue' && projectDetails?.minimumProdexSuppliers"
        class="actions"
      >
        <button
          [disabled]="!canReleaseToSelectedProdEXSuppliers || projectDetails?.minimumProdexSuppliers === 0"
          (click)="releaseProjectToSupplier()"
          type="button"
          class="btn theme green"
        >
          Release Project to Supplier
        </button>
      </div>
    </div>

    <div class="w-100 h-100 theme-table">
      <ag-grid-angular
        *ngIf="projectDetails?.minimumProdexSuppliers"
        class="ag-theme-balham h-100 w-100"
        [rowData]="projectDetails?.prodexSuppliers"
        [gridOptions]="supplierGridOptions[0]"
        (gridReady)="onSuppliersGridReady(0, $event)"
      >
      </ag-grid-angular>
      <p *ngIf="!projectDetails?.minimumProdexSuppliers" class="font-md text-center text-orange">
        No ProdEX Supplier Requested
      </p>
      <!-- <p class="font-md text-center text-orange" *ngIf="
          (projectDetails?.minimumProdexSuppliers && !projectDetails?.prodexSuppliers) ||
          projectDetails?.prodexSuppliers?.length == 0
        ">
        No ProdEX supplier found. Please check ProdEX supplier has ShopSight 360 Plus subscription.
      </p> -->
    </div>
  </div>

  <div class="my-4 customer-selected-supplier">
    <div class="heading d-flex justify-content-between align-items-end mb-3">
      <h6>Customer Selected Supplier</h6>
      <div class="actions"></div>
    </div>

    <div class="w-100 h-100 theme-table">
      <ag-grid-angular
        class="ag-theme-balham w-100 h-100"
        [rowData]="projectDetails?.customerSelectedSuppliers"
        [gridOptions]="supplierGridOptions[1]"
        (gridReady)="onSuppliersGridReady(0, $event)"
      >
      </ag-grid-angular>
    </div>
  </div>

  <div class="my-4 customer-selected-invite">
    <div class="heading d-flex justify-content-between align-items-end mb-3">
      <h6>Customer Supplier To Invite</h6>
      <div *ngIf="this.pageType === 'release-queue'" class="actions">
        <button
          [disabled]="!canReleaseToInvitedEXSuppliers"
          type="button"
          class="btn  theme green"
          (click)="releaseProjectToInvite()"
        >
          Release Project to Supplier
        </button>
      </div>
    </div>

    <div class="w-100 h-100 theme-table">
      <ag-grid-angular
        class="ag-theme-balham"
        [rowData]="projectDetails?.customerInvitedSuppliers"
        [gridOptions]="supplierGridOptions[2]"
        (gridReady)="onSuppliersGridReady(0, $event)"
      >
      </ag-grid-angular>
    </div>
  </div>
</div>

<ng-template #vendorCell let-row>
  <div class="d-flex flex-row w-100 h-100">
    <span class="text-light-blue hover-bold cursor-pointer underline" (click)="showVendorProfiles($event, row)">{{
      row.vendor
    }}</span>
  </div>
</ng-template>

<ng-template #replaceSupplierCell let-row>
  <div *ngIf="!firstTimeRelease && this.pageType === 'release-queue'" class="h-100 d-flex flex-row align-items-center">
    <button class="btn btn-cell theme white p-0" (click)="showReplacementProfiles($event, row)">
      Replace Supplier
    </button>
  </div>
</ng-template>

<ng-template #checkProgressCell let-row>
  <div
    *ngIf="row?.status && statusTypes[row?.status] !== statusTypes?.VENDOR_RECEIVED"
    class="h-100 d-flex flex-row align-items-center"
  >
    <button class="btn btn-cell transparent text-theme-green p-0" (click)="checkProgress($event, row)">
      Check Progress
    </button>
  </div>
</ng-template>

<ng-template #createProfileCell let-row>
  <div *ngIf="!row?.isRegistered" class="h-100 d-flex flex-row justify-content-center align-items-center">
    <button class="btn btn-cell theme white p-0" (click)="createVendorProfile(row)">Create Profile</button>
  </div>
</ng-template>

<ng-template #emailCell let-row>
  <div *ngIf="row?.email" class="d-flex flex-row justify-content-center align-items-center w-100">
    <span
      (click)="sendMail(row)"
      class="email-icon hover-bold cursor-pointer text-theme-green text-btn"
      title="Send mail"
    >
      <i class="far fa-envelope"></i>
    </span>
  </div>
</ng-template>

<ng-template #sendMailModal let-modal>
  <app-send-mail-modal [from]="from" [to]="to" [cc]="cc" [bcc]="bcc" (close)="modal.dismiss()"></app-send-mail-modal>
</ng-template>

<ng-template #statusCell let-row>
  <div class="d-flex flex-row align-items-center w-100 h-100">
    <ng-container [ngSwitch]="row?.status">
      <div *ngSwitchCase="'VENDOR_REJECTED'" class="text-orange">{{ statusTypes[row?.status] }}</div>
      <div *ngSwitchCase="'CUSTOMER_DECLINED'" class="text-orange">{{ statusTypes[row?.status] }}</div>
      <div *ngSwitchDefault>{{ statusTypes[row?.status] }}</div>
    </ng-container>
  </div>
</ng-template>

<ng-template #vendorProfileModal let-modal>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title text-theme text-capitalize w-100 pl-3" id="modal-basic-title">
        "{{ selectedVendor.vendorName }}" Profiles
      </h5>
      <button type="button" class="close" aria-label="Close" (click)="modal.close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body theme-table">
      <ag-grid-angular
        class="ag-theme-balham w-100 h-100"
        [rowData]="vendorProfiles"
        [gridOptions]="vendorProfileGridOptions[0]"
        (gridReady)="onVendorProfileReady(0, $event)"
      >
      </ag-grid-angular>
    </div>
  </div>
</ng-template>

<ng-template #replacementProfileModal let-modal>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title text-theme text-capitalize w-100 pl-3" id="modal-basic-title">
        Choose 1 more vendor
      </h5>
      <button type="button" class="close" aria-label="Close" (click)="modal.close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body replacement-profile theme-table">
      <h6 class="text-theme">Matching Supplier Queue</h6>
      <ag-grid-angular
        class="ag-theme-balham w-100 h-75"
        [rowData]="replacementProdexSuppliers"
        [gridOptions]="vendorProfileGridOptions[1]"
        (gridReady)="onVendorProfileReady(1, $event)"
      >
      </ag-grid-angular>

      <div class="w-100 mt-2 d-flex row justify-content-center">
        <div class="col-4">
          <button
            ngbAutofocus
            (click)="replaceSupplier()"
            [disabled]="selectedReplacementProdEXVendorIds.length !== 1"
            class="btn theme green"
          >
            Release Project to Supplier
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #checkProgressModal let-modal>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title text-theme text-capitalize w-100 pl-3" id="modal-basic-title">
        Check Progress
      </h5>
      <button type="button" class="close" aria-label="Close" (click)="modal.close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body text-theme">
      <div class="mb-3 section">
        <h5 class="mt-2">
          Notes History
          <span
            *ngIf="(progressInfo?.messages?.messageNotes || []).length"
            class="ml-2 text-theme-green font-sm cursor-pointer"
            (click)="showNoteHistory = !showNoteHistory"
          >
            {{ !showNoteHistory ? 'See' : 'Hide' }} note history
            <span *ngIf="!showNoteHistory">
              <i class="fas fa-chevron-down"></i>
            </span>
            <span *ngIf="showNoteHistory">
              <i class="fas fa-chevron-up"></i>
            </span>
          </span>
        </h5>

        <div *ngIf="showNoteHistory" class="note-history p-2">
          <div *ngFor="let item of progressInfo?.messages?.messageNotes" class="ml-2 font-sm row">
            <span
              class="font-italic"
              *ngIf="item?.senderId === (projectDetails?.parts)[0]?.userId"
              class="col-6 pl-0 text-left"
              >Customer : {{ (projectDetails?.parts)[0]?.customerName }}
            </span>
            <span
              class="font-italic"
              *ngIf="item?.senderId !== (projectDetails?.parts)[0]?.userId"
              class="col-6 pl-0 text-left"
              >Vendor : {{ selectedVendor?.vendorName }}
            </span>
            <span class="pl-3">{{ item?.createdDate | date: util.dateFormatWithTime }}</span>
          </div>
        </div>

        <p class="mb-2 item">
          Number of customer and vendor message:
          <span class="value font-weight-bold">{{ progressInfo?.messages?.numberOfCustomerAndVendorMessages }}</span>
        </p>
        <p class="mb-2 item">
          Last customer and vendor message time:
          <span class="value font-weight-bold">{{
            progressInfo?.messages?.lastCustomerAndVendorMessageTime | date: util.dateFormatWithTime
          }}</span>
        </p>
      </div>
      <div class="mb-3 section">
        <h5 class="mt-2">Proposal History</h5>
        <p class="mb-2 item">
          Has bid been issued:
          <span class="value font-weight-bold">{{
            progressInfo?.isProposalIssued ? 'Yes' : progressInfo?.isProposalIssued === false ? 'No' : ''
          }}</span>
        </p>
        <p class="mb-2 item">
          How much is bid been issued for:
          <span class="value font-weight-bold">{{ progressInfo?.proposalAmount | currency: '$' }}</span>
        </p>
        <p *ngIf="progressInfo?.isProposalIssued" class="mb-2 item">
          All bid details:
          <span class="text-light-blue hover-bold cursor-pointer underline">
            <!-- See all proposal details -->
            <app-proposal-form
              [vendorId]="selectedVendor?.vendorId"
              [partIds]="projectDetails?.partIds"
              [values]="proposalPartIds"
            >
            </app-proposal-form>
          </span>
        </p>
      </div>
      <div class="mb-3 section">
        <h5 class="mt-2">
          Zoom Meeting History
          <span
            *ngIf="(progressInfo?.zoomMeeting?.lastZoomDiscussionsCompleted || []).length"
            class="ml-2 text-theme-green font-sm cursor-pointer"
            (click)="showZoomHistory = !showZoomHistory"
          >
            {{ !showZoomHistory ? 'See' : 'Hide' }} zoom history
            <span *ngIf="!showZoomHistory">
              <i class="fas fa-chevron-down"></i>
            </span>
            <span *ngIf="showZoomHistory">
              <i class="fas fa-chevron-up"></i>
            </span>
          </span>
        </h5>

        <div *ngIf="showZoomHistory" class="zoom-history p-2">
          <p class="text-theme vendor-name mb-2">
            Vendor : <span class="text-theme-green">{{ selectedVendor?.vendorName }}</span>
          </p>
          <div *ngFor="let item of progressInfo?.zoomMeeting?.lastZoomDiscussionsCompleted" class="ml-2 font-sm">
            <span class="font-italic">Created Time : </span>
            <span>{{ item?.createdTime | date: util.dateFormatWithTime }}</span>
            <span class="font-italic ml-2">Scheduled Time : </span>
            <span>{{ item?.startTime | date: util.dateFormatWithTime }}</span>
          </div>
        </div>

        <p class="mb-2 item">
          Zoom discussions completed:
          <span class="value font-weight-bold">{{ progressInfo?.zoomMeeting?.numberOfZoomDiscussionsCompleted }}</span>
        </p>
        <p class="mb-2 item">
          Last Zoom discussions completed:
          <span class="value font-weight-bold">{{
            progressInfo?.zoomMeeting?.lastZoomDiscussionCompleted | date: util.dateFormatWithTime
          }}</span>
        </p>
        <p class="mb-2 item">
          Next Zoom discussions:
          <span class="value font-weight-bold">{{
            progressInfo?.zoomMeeting?.nextZoomDiscussionScheduled | date: util.dateFormatWithTime
          }}</span>
        </p>
      </div>
    </div>
  </div>
</ng-template>
