<button
  [popoverClass]="'chat-container'"
  [autoClose]="false"
  [placement]="'auto'"
  [ngbPopover]="popContent"
  [popoverTitle]="popTitle"
  container="body"
  #popOverRef="ngbPopover"
  [closePopoverOnClickOutside]="popOverRef"
  (click)="openChat($event)"
  [disabled]="loading"
  class="btn white bg-transparent w-auto chat-button position-relative"
>
  <ng-container *ngIf="!loading; else loadingPanel">
    <span><i class="fas fa-comment-alt"></i></span>
  </ng-container>
  <span class="unread-badge position-absolute" *ngIf="value?.messageNotes | unReadCount: user.id as count">
    {{ count }}
  </span>
</button>

<ng-template #popContent>
  <div class="col-12 border p-0 d-flex flex-column">
    <ng-container *ngIf="value?.messageNotes?.length > 0">
      <app-message-viewer [(value)]="value.messageNotes"> </app-message-viewer>
    </ng-container>
    <ng-container *ngIf="(value?.messageNotes?.length || 0) === 0">
      <div class="empty-chat d-flex align-items-center justify-content-center">
        <div class="participant-chat text-left">
          No chats found
        </div>
      </div>
    </ng-container>
    <form class="pl-2 pr-2 pt-3 pb-3 w-100 align-bottom" [formGroup]="noteFormGroup">
      <hr class="m-0" />
      <div class="form-row">
        <div class="form-group theme col-12 m-0">
          <label class="w-100">
            Note
            <textarea
              class="form-control note-input"
              rows="2"
              formControlName="note"
              (keyup.enter)="sendNote($event)"
            ></textarea>
          </label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group theme col-12 m-0 d-flex justify-content-center position-relative">
          <button class="btn btn-white pl-4 pr-4" [disabled]="!noteFormGroup.valid" (click)="addNote()">
            {{ loading ? 'Submitting Note' : 'Add Note' }}
          </button>
          <app-attachment
            *ngIf="value && value.id && (value.participants || []).indexOf(user.id) > -1"
            [chatId]="value.id"
            [openAttachment]="trigger$ | async"
            class="d-block position-absolute attachment-btn"
          >
          </app-attachment>
          <button
            *ngIf="!(value && value.id && (value.participants || []).indexOf(user.id) > -1)"
            class="d-block position-absolute attachment-btn btn btn-white pl-3 pr-3 text-theme-green"
            (click)="addNote(true)"
          >
            <i class="fas fa-paperclip"></i>
          </button>
        </div>
      </div>
    </form>
  </div>
</ng-template>

<ng-template #popTitle>
  <h5 class="text-theme-green align-top text-center m-0 pt-3 pb-3 shadow">
    Message to Vendor
  </h5>
</ng-template>

<ng-template #loadingPanel>
  <svg xmlns="http://www.w3.org/2000/svg" width="15" height="20" viewBox="0 0 135 140" fill="#74bf09">
    <rect y="30.3115" width="15" height="79.377" rx="6">
      <animate
        attributeName="height"
        begin="0.5s"
        dur="1s"
        values="120;110;100;90;80;70;60;50;40;140;120"
        calcMode="linear"
        repeatCount="indefinite"
      />
      <animate
        attributeName="y"
        begin="0.5s"
        dur="1s"
        values="10;15;20;25;30;35;40;45;50;0;10"
        calcMode="linear"
        repeatCount="indefinite"
      />
    </rect>
    <rect x="30" y="14.4689" width="15" height="111.062" rx="6">
      <animate
        attributeName="height"
        begin="0.25s"
        dur="1s"
        values="120;110;100;90;80;70;60;50;40;140;120"
        calcMode="linear"
        repeatCount="indefinite"
      />
      <animate
        attributeName="y"
        begin="0.25s"
        dur="1s"
        values="10;15;20;25;30;35;40;45;50;0;10"
        calcMode="linear"
        repeatCount="indefinite"
      />
    </rect>
    <rect x="60" width="15" height="86.0623" rx="6" y="26.9688">
      <animate
        attributeName="height"
        begin="0s"
        dur="1s"
        values="120;110;100;90;80;70;60;50;40;140;120"
        calcMode="linear"
        repeatCount="indefinite"
      />
      <animate
        attributeName="y"
        begin="0s"
        dur="1s"
        values="10;15;20;25;30;35;40;45;50;0;10"
        calcMode="linear"
        repeatCount="indefinite"
      />
    </rect>
    <rect x="90" y="14.4689" width="15" height="111.062" rx="6">
      <animate
        attributeName="height"
        begin="0.25s"
        dur="1s"
        values="120;110;100;90;80;70;60;50;40;140;120"
        calcMode="linear"
        repeatCount="indefinite"
      />
      <animate
        attributeName="y"
        begin="0.25s"
        dur="1s"
        values="10;15;20;25;30;35;40;45;50;0;10"
        calcMode="linear"
        repeatCount="indefinite"
      />
    </rect>
    <rect x="120" y="30.3115" width="15" height="79.377" rx="6">
      <animate
        attributeName="height"
        begin="0.5s"
        dur="1s"
        values="120;110;100;90;80;70;60;50;40;140;120"
        calcMode="linear"
        repeatCount="indefinite"
      />
      <animate
        attributeName="y"
        begin="0.5s"
        dur="1s"
        values="10;15;20;25;30;35;40;45;50;0;10"
        calcMode="linear"
        repeatCount="indefinite"
      />
    </rect>
  </svg>
</ng-template>
